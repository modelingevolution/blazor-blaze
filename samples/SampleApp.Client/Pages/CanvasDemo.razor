@page "/canvas"
@rendermode InteractiveWebAssembly
@using BlazorBlaze
@using ModelingEvolution.Drawing
@using SkiaSharp
@implements IDisposable

<PageTitle>BlazorBlaze Canvas Demo</PageTitle>

<h1>BlazorBlaze Canvas Demo</h1>

<div style="width: 800px; height: 500px; border: 1px solid #ccc;">
    <BlazorCanvas Engine="_engine" Size="Sizes.HD" />
</div>

<div class="mt-3">
    <button class="btn btn-primary me-2" @onclick="AddCircle">Add Circle</button>
    <button class="btn btn-success me-2" @onclick="AddRectangle">Add Rectangle</button>
    <button class="btn btn-warning me-2" @onclick="AddPolygon">Add Polygon</button>
    <button class="btn btn-secondary" @onclick="Clear">Clear All</button>
</div>

<p class="mt-2">Controls: @_controlCount | Click shapes to change color, drag to move!</p>

@code {
    private BlazeEngine _engine = null!;
    private int _controlCount = 0;
    private List<Control> _controls = new();

    protected override void OnInitialized()
    {
        _engine = new BlazeEngine(Sizes.HD);

        // Add some initial shapes
        AddCircle();
        AddRectangle();
        AddPolygon();
    }

    private void AddCircle()
    {
        var rand = Random.Shared;
        var x = rand.Next(100, 700);
        var y = rand.Next(100, 400);
        var radius = rand.Next(20, 60);

        var circle = new CircleControl(new SKPoint(x, y), radius);
        var color = new SKColor((byte)rand.Next(256), (byte)rand.Next(256), (byte)rand.Next(256));
        circle.Fill = color;
        circle.Stroke = SKColors.White;
        circle.StrokeWidth = 2;
        circle.EnableDrag();

        circle.OnClick += (s, e) => circle.Fill = new SKColor((byte)rand.Next(256), (byte)rand.Next(256), (byte)rand.Next(256));

        _engine.Scene.AddControl(circle);
        _controls.Add(circle);
        _controlCount = _controls.Count;
        StateHasChanged();
    }

    private void AddRectangle()
    {
        var rand = Random.Shared;
        var x = rand.Next(100, 600);
        var y = rand.Next(100, 350);
        var w = rand.Next(50, 150);
        var h = rand.Next(50, 100);

        var rect = new RectangleControl(new SKRect(x, y, x + w, y + h));
        rect.Fill = new SKColor((byte)rand.Next(256), (byte)rand.Next(256), (byte)rand.Next(256));
        rect.Stroke = SKColors.White;
        rect.StrokeWidth = 2;
        rect.EnableDrag();

        rect.OnClick += (s, e) => rect.Fill = new SKColor((byte)rand.Next(256), (byte)rand.Next(256), (byte)rand.Next(256));

        _engine.Scene.AddControl(rect);
        _controls.Add(rect);
        _controlCount = _controls.Count;
        StateHasChanged();
    }

    private void AddPolygon()
    {
        var rand = Random.Shared;
        var centerX = rand.Next(150, 650);
        var centerY = rand.Next(150, 350);
        var sides = rand.Next(3, 8);
        var radius = rand.Next(30, 80);

        var points = new Point<float>[sides];
        for (int i = 0; i < sides; i++)
        {
            var angle = (float)(2 * Math.PI * i / sides - Math.PI / 2);
            points[i] = new Point<float>(
                centerX + radius * MathF.Cos(angle),
                centerY + radius * MathF.Sin(angle)
            );
        }

        var polygon = new PolygonControl(new Polygon<float>(points));
        polygon.Fill = new SKColor((byte)rand.Next(256), (byte)rand.Next(256), (byte)rand.Next(256));
        polygon.Stroke = SKColors.White;
        polygon.StrokeWidth = 2;
        polygon.EnableDrag();

        polygon.OnClick += (s, e) => polygon.Fill = new SKColor((byte)rand.Next(256), (byte)rand.Next(256), (byte)rand.Next(256));

        _engine.Scene.AddControl(polygon);
        _controls.Add(polygon);
        _controlCount = _controls.Count;
        StateHasChanged();
    }

    private void Clear()
    {
        foreach (var control in _controls)
        {
            _engine.Scene.RemoveControl(control);
        }
        _controls.Clear();
        _controlCount = 0;
        StateHasChanged();
    }

    public void Dispose()
    {
        _controls.Clear();
    }
}
